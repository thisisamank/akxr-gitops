# Immich Staging Configuration

controllers:
  main:
    containers:
      main:
        image:
          tag: v2.0.0
        env:
          REDIS_HOSTNAME: '{{ printf "%s-valkey" .Release.Name }}'
          IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
          # Database configuration - using dedicated Immich PostgreSQL
          DB_HOSTNAME: '{{ printf "%s-postgresql" .Release.Name }}'
          DB_PORT: "5432"
          DB_DATABASE_NAME: immich
          DB_USERNAME: immich
          DB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: immich-db-secret
                key: DB_PASSWORD

# Immich-specific configuration
immich:
  metrics:
    enabled: false
  persistence:
    library:
      # Create the PVC for media storage
      create: true
      existingClaim: immich-library
      storageClass: longhorn
      size: 512Gi
      accessMode: ReadWriteOnce
  configuration: {}

# PostgreSQL with vectorchord extension for Immich
database:
  enabled: true
  image:
    # TensorChord PostgreSQL image with vectorchord extension
    repository: ghcr.io/tensorchord/cloudnative-vectorchord
    tag: "16.9-0.4.3"
    pullPolicy: IfNotPresent
  auth:
    username: immich
    database: immich
    existingSecret: immich-db-secret
    secretKeys:
      passwordKey: DB_PASSWORD
  persistence:
    storageClass: longhorn
    size: 20Gi
    accessMode: ReadWriteOnce
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 250m
      memory: 512Mi
  # Node placement for staging
  nodeSelector:
    node-type: staging
  tolerations:
    - key: node
      operator: Equal
      value: staging
      effect: NoSchedule

# Valkey (Redis replacement) - enabled for job queues
valkey:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: docker.io/valkey/valkey
            tag: 9.0-alpine@sha256:b4ee67d73e00393e712accc72cfd7003b87d0fcd63f0eba798b23251bfc9c394
            pullPolicy: IfNotPresent
  # Node placement for staging
  defaultPodOptions:
    nodeSelector:
      node-type: staging
    tolerations:
      - key: node
        operator: Equal
        value: staging
        effect: NoSchedule
  persistence:
    data:
      enabled: true
      size: 2Gi
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      storageClass: longhorn

# Server configuration
server:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-server
            pullPolicy: IfNotPresent
            tag: "v2.3.1"
          resources:
            limits:
              cpu: 4000m
              memory: 4Gi
            requests:
              cpu: 500m
              memory: 1Gi
  # Node placement for staging
  defaultPodOptions:
    nodeSelector:
      node-type: staging
    tolerations:
      - key: node
        operator: Equal
        value: staging
        effect: NoSchedule
  # Ingress configuration for photos.akxr.in
  ingress:
    main:
      enabled: true
      className: traefik
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
        traefik.ingress.kubernetes.io/router.entrypoints: web
      hosts:
        - host: photos.akxr.in
          paths:
            - path: "/"
              service:
                identifier: main
      tls:
        - secretName: nexus-tls-prod
          hosts:
            - photos.akxr.in

# Machine Learning configuration
machine-learning:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-machine-learning
            pullPolicy: IfNotPresent
          env:
            TRANSFORMERS_CACHE: /cache
            HF_XET_CACHE: /cache/huggingface-xet
            MPLCONFIGDIR: /cache/matplotlib-config
          resources:
            limits:
              cpu: 2000m
              memory: 4Gi
            requests:
              cpu: 500m
              memory: 1Gi
  # Node placement for staging
  defaultPodOptions:
    nodeSelector:
      node-type: staging
    tolerations:
      - key: node
        operator: Equal
        value: staging
        effect: NoSchedule
  persistence:
    cache:
      enabled: true
      size: 15Gi
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      storageClass: longhorn
