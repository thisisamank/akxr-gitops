image:
  repository: registry
  tag: "2.8.2"
  pullPolicy: Always

replicaCount: 1

service:
  type: ClusterIP
  port: 5000

ingress:
  enabled: true
  className: "traefik"
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
  hosts:
    - host: registry.pixr.in
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: nexus-tls-prod
      hosts:
        - registry.pixr.in

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Pod labels and annotations
podLabels:
  app: docker-registry
  version: v1

podAnnotations:
  description: "Self-hosted Docker registry"

# Security context - registry image runs as root by default, but we set fsGroup for volume permissions
podSecurityContext:
  fsGroup: 0

securityContext:
  runAsUser: 0
  runAsGroup: 0
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# Environment variables for Docker registry
env:
  - name: REGISTRY_AUTH
    value: htpasswd
  - name: REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY
    value: /var/lib/registry
  - name: REGISTRY_STORAGE_DELETE_ENABLED
    value: "true"
  - name: REGISTRY_HTTP_HOST
    value: https://registry.pixr.in
  - name: REGISTRY_HTTP_SECRET
    valueFrom:
      secretKeyRef:
        name: docker-registry-auth
        key: http-secret
  - name: REGISTRY_AUTH_HTPASSWD_REALM
    value: "Registry Realm"
  - name: REGISTRY_AUTH_HTPASSWD_PATH
    value: /auth/htpasswd

# Use PVC instead of hostPath for production-grade storage
persistentVolumeClaim:
  enabled: true
  storageClassName: "longhorn"
  accessModes:
    - ReadWriteOnce
  size: 50Gi
  mountPath: /var/lib/registry

# Additional volumes for auth secret and config
volumes:
  - name: registry-auth
    secret:
      secretName: docker-registry-auth
      items:
        - key: htpasswd
          path: htpasswd
  - name: registry-config
    configMap:
      name: docker-registry-config

volumeMounts:
  - name: registry-auth
    mountPath: /auth
    readOnly: true
  - name: registry-config
    mountPath: /etc/docker/registry
    readOnly: true

# Health checks - use TCP to avoid HTTP 401 when auth is enabled
livenessProbe:
  tcpSocket:
    port: 5000
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  tcpSocket:
    port: 5000
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Control plane node placement (matches other core apps)
nodeSelector:
  kubernetes.io/hostname: talos-ute-nle

tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule
