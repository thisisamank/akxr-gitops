# Immich - Core deployment (control plane)
# Photo management on hostPath storage

# Control plane node placement
defaultPodOptions:
  nodeSelector:
    kubernetes.io/hostname: talos-ute-nle
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule

controllers:
  main:
    containers:
      main:
        image:
          tag: v2.0.0
        env:
          REDIS_HOSTNAME: '{{ printf "%s-valkey" .Release.Name }}'
          IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
          # PostgreSQL connection - using bundled PostgreSQL with pgvecto.rs
          DB_HOSTNAME: '{{ printf "%s-postgresql" .Release.Name }}'
          DB_PORT: "5432"
          DB_DATABASE_NAME: "immich"
          DB_USERNAME: "immich"
          DB_PASSWORD: "immich-secret-password"

immich:
  metrics:
    enabled: false
  persistence:
    library:
      # Use hostPath on control plane node for photo storage
      hostPath: /var/mnt/media/immich
      node: talos-ute-nle
      size: 500Gi
  configuration: {}

# Bundled PostgreSQL with pgvecto.rs for vector search
postgresql:
  enabled: true
  image:
    # Official Immich PostgreSQL image with pgvecto.rs extension
    repository: tensorchord/pgvecto-rs
    tag: pg14-v0.2.0
    pullPolicy: IfNotPresent
  auth:
    username: immich
    password: immich-secret-password
    database: immich
  persistence:
    # Use hostPath for database storage
    hostPath: /var/mnt/media/immich-db
    node: talos-ute-nle
    size: 20Gi
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 1Gi

# Valkey (Redis) for caching
valkey:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: docker.io/valkey/valkey
            tag: 9.0-alpine@sha256:b4ee67d73e00393e712accc72cfd7003b87d0fcd63f0eba798b23251bfc9c394
            pullPolicy: IfNotPresent
  persistence:
    data:
      enabled: true
      size: 2Gi
      type: emptyDir
      accessMode: ReadWriteOnce

# Immich Server
server:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-server
            pullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              memory: 2Gi
  ingress:
    main:
      enabled: true
      className: "traefik"
      annotations:
        traefik.ingress.kubernetes.io/router.entrypoints: web
        # Allow large uploads
        traefik.ingress.kubernetes.io/buffering: "0"
      hosts:
        - host: photos.akxr.in
          paths:
            - path: "/"
              service:
                identifier: main
      tls:
        - secretName: nexus-tls-prod
          hosts:
            - photos.akxr.in

# Machine Learning for face recognition, search, etc.
machine-learning:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-machine-learning
            pullPolicy: IfNotPresent
          env:
            TRANSFORMERS_CACHE: /cache
            HF_XET_CACHE: /cache/huggingface-xet
            MPLCONFIGDIR: /cache/matplotlib-config
          resources:
            requests:
              cpu: 100m
              memory: 1Gi
            limits:
              memory: 4Gi
  persistence:
    cache:
      enabled: true
      size: 10Gi
      type: emptyDir
      accessMode: ReadWriteOnce
